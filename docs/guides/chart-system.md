# Chart Building System

This project includes a modular, extensible chart building system that generates interactive Plotly charts from declarative YAML specifications.

## Architecture

### 1. Chart Specifications (`docs/_data/charts.yml`)
Declarative YAML file that defines what charts to build:

```yaml
charts:
  - name: my-chart
    type: line_multi
    data: path/to/data.csv
    params:
      x: date_column
      ys: ["metric1", "metric2"]
      title: "My Chart Title"
    output: path/to/output.html
    meta:
      slug: chart-category
      alt: "Chart description"
```

### 2. Theme Configuration (`docs/_data/site.yml`)
Centralized theme tokens ensure consistent branding:

```yaml
brand:
  name: "Embuild"

charts:
  colors:
    primary: "#005EB8"
    secondary: "#00A3E0"
    accent: "#FFC300"
  font_family: "Inter, system-ui, sans-serif"
  title_size: 20
  template: "simple_white"
```

### 3. Chart Registry (`macros/charts.py`)
Extensible registry of chart builders. Current chart types:

- `line_multi`: Multi-line time series charts
- `bar_grouped`: Grouped bar charts  
- `scatter_trend`: Scatter plots with trend lines

To add a new chart type:

```python
@chart("my_new_type")
def my_new_chart(data: str, params: dict):
    th = load_theme()
    df = pd.read_csv(data)
    fig = px.my_chart_type(df, **params)
    # Apply theme...
    return fig
```

### 4. Build System (`scripts/build_charts.py`)
Smart incremental building with caching:

```bash
# Build all charts
uv run python scripts/build_charts.py
```

Features:
- **Incremental builds**: Only rebuilds when specs, data, or theme changes
- **Fingerprint caching**: Stores build hashes in `.cache/charts.json`
- **Error handling**: Continues building other charts if one fails
- **Performance tracking**: Reports build times and cache hits

## Usage

### Building Charts

1. **Add chart specification** to `docs/_data/charts.yml`
2. **Run the builder**:
   ```bash
   uv run python scripts/build_charts.py
   ```
3. **Charts are generated** as standalone HTML files with Plotly.js via CDN

### Asset Integration

Update your asset YAML files to reference the generated HTML:

```yaml
# docs/assets/my-analysis/asset.yml
files:
  csv: data.csv
  html: my-chart.html  # Generated by chart builder
```

Your existing asset generator will automatically create embed pages that iframe the interactive charts.

### CI/CD Integration

Add to your build pipeline before `mkdocs build`:

```yaml
- name: Build Charts
  run: uv run python scripts/build_charts.py
- name: Build Site  
  run: mkdocs build
```

## Benefits

- **Declarative**: Add charts by writing YAML, not code
- **Consistent**: All charts use the same theme and branding
- **Fast**: Incremental builds skip unchanged charts
- **Extensible**: Add new chart types with a simple decorator
- **Versionable**: Chart outputs are committed and tracked
- **Embeddable**: Integrates seamlessly with existing asset system

## File Structure

```
docs/
├── _data/
│   ├── site.yml          # Theme configuration
│   └── charts.yml        # Chart specifications
└── assets/
    └── my-analysis/
        ├── asset.yml     # Asset metadata + HTML reference
        ├── data.csv      # Source data
        └── chart.html    # Generated interactive chart

macros/
└── charts.py             # Chart registry and builders

scripts/
└── build_charts.py       # Build system CLI

.cache/
└── charts.json           # Build fingerprints for caching
```
